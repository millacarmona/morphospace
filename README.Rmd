---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(dpi=400)
```

# morphospace

<!-- badges: start -->
<!-- badges: end -->

A package for people who can't visualize morphospaces good and wanna learn to do other geometric morphometrics stuff good too.

## Installation

You can install the development version of morphospace from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("millacarmona/morphospace")
```

## Purpose


This package is intended to aid exploration and depiction of multivariate ordinations of shape data obtained through geometric morphometrics analyses. The functions from `morphospace` have been designed to work in an integrated workflow along other widely used geometric morphometrics R packages such as `Morpho`, `geomorph`, and `Momocs`, whose functions cover more essential steps of morphometric analysis (e.g. import, normalization, and statistical analysis).

Below, the general concept and capabilities of  `morphospace` are displayed using two data sets representing different types of geometric morphometric data. The first data set, taken from from Fasanelli et al. (2022), contains a sample of tail shapes from the 13 species of the genus *Tyrannus*, two of which (*T. savana* and *T. forficatus*) display exaggeratedly elongated tails, as well as a considerable allometric variation and sexual dimorphism in tail shape. The `tails` data set contains landmark data and centroid sizes from the tails of 281 specimens, their classification to species and sex, and the phylogenetic relationships between *Tyrannus* species (Harvey et al. 2020). Also included are the links between landmarks to aid visualization of landmark configurations.


```{r}
library(morphospace)
library(geomorph)

# Load tail data and extract shapes, centroid sizes, classification of sex and species,
# links between landmarks, and phylogenetic tree

data("tails")
shapes <- tails$shapes
species <- tails$data$species
sizes <- tails$sizes
sex <- tails$data$sex
links <- tails$links
tree <- tails$tree
```

Morphometric variation is assumed to be already free of differences of orientation, position and scale. This standardization can be readily performed using functions from the aforementioned R packages.

```{r}
# Inspect shapes
pile_shapes(shapes, links = links)
```


## Shapes operations

This package provide some functions that perform basic operations with shape variables, such as the calculation of mean shapes or the analytical removal of undesired sources of variation.

```{r}
# Remove variation associated to sexual dimorphism and compute the consensus shape
# of each species
cons_shapes <- consensus(shapes = shapes, index = species)
detr_shapes <- arrayspecs(detrend_shapes(model = lm(two.d.array(shapes) ~ sex)),
                          p = nrow(shapes), k = ncol(shapes))
detr_cons_shapes <- consensus(shapes = detr_shapes, index = species)
```


## Workflow


The basic idea behind the `morphospace` workflow is to build (empiric) morphospaces using multivariate methods (PCA and the likes), then use the resulting synthesis as a reference in which to project different elements. These elements are added both to the plot and the `"mspace"` object as succesive 'layers' or list slots, respectively, using the `%>%` pipe operator from `magrittr`.

```{r}
# Create and plot morphospace using detrended shapes, and project specimens
morphospace1 <- mspace(detr_shapes, links = links, mag = 0.7, axes = c(1,2)) %>%
  proj_shapes(shapes = detr_shapes)


# Plot morphospace, project specimens and delimit species' range of variation
#using convex hulls
morphospace2 <- mspace(detr_shapes, links = links, mag = 0.7, axes = c(1,2)) %>%
  proj_shapes(shapes = detr_shapes, col = species) %>%
  proj_groups(shapes = detr_shapes, groups = species)


# Plot morphospace, project each species' mean shape and range of variation
morphospace3 <- mspace(detr_shapes, links = links, mag = 0.7, axes = c(1,2)) %>%
  proj_consensus(shapes = detr_cons_shapes, pch = 21, bg = 1:13, cex = 1.2) %>%
  proj_groups(shapes = detr_shapes, groups = species)


# Plot morphospace, project species' meanshapes and phylogenetic structure
#(requires a phy object)
morphospace4 <- mspace(detr_shapes, links = links, mag = 0.7, axes = c(1,2)) %>%
  proj_consensus(shapes = detr_cons_shapes, pch = 21, bg = 1:13, cex = 1.2) %>%
  proj_phylogeny(tree = tree, pch = 16)


names(morphospace1)
names(morphospace2)
names(morphospace3)
names(morphospace4)

```













You'll still need to render `README.Rmd` regularly, to keep `README.md` up-to-date. `devtools::build_readme()` is handy for this. You could also use GitHub Actions to re-render `README.Rmd` every time you push. An example workflow can be found here: <https://github.com/r-lib/actions/tree/v1/examples>.

You can also embed plots, for example:

In that case, don't forget to commit and push the resulting figure files, so they display on GitHub and CRAN.
